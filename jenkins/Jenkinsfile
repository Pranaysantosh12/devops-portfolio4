pipeline {
    agent any

    environment {
        IMAGE_NAME = 'devops-portfolio'
        TAG = 'v1'
        DEPLOYMENT_FILE = 'k8s-deployment.yaml'
    }

    stages {
        stage('Step 1: Clone Repository') {
            steps {
                echo 'üì• Cloning GitHub repo...'
                git(
                    url: 'https://github.com/Pranaysantosh12/devops-portfolio4.git',
                    branch: 'master',
                    credentialsId: 'jenkins-tokenv2'
                )
            }
        }

        stage('Step 2: Confirm Files (safe way)') {
            steps {
                echo 'üßæ Showing project file list:'
                script {
                    def fileList = ''
                    def process = 'ls -1'.execute()
                    process.waitFor()
                    fileList = process.in.text
                    echo fileList
                }
            }
        }

        stage('Step 3: Simulate Docker Build') {
            steps {
                echo '‚öôÔ∏è Simulating Docker build (no Docker Desktop)...'
                echo "Command would be: docker build -t ${IMAGE_NAME}:${TAG} ."
            }
        }

        stage('Step 4: Kubernetes Deployment') {
            steps {
                echo 'üöÄ Deploying to Kubernetes...'
                script {
                    try {
                        def result = "kubectl apply -f ${DEPLOYMENT_FILE}".execute()
                        result.waitFor()
                        echo result.in.text
                    } catch (Exception e) {
                        error("‚ùå Kubernetes deployment failed: ${e.message}")
                    }
                }
            }
        }

        stage('Step 5: Confirmation') {
            steps {
                echo '‚úÖ Pipeline completed successfully with all steps.'
            }
        }
    }
}
